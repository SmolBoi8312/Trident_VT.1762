[include chopper_tune.cfg]
[include mainsail.cfg]
[include mainsail_peram.cfg]
[include homing.cfg]
[include start_end.cfg]
[include test_speed.cfg]
[include adap_filament_load.cfg]
[include tmc_autotune.cfg]
[include timelapse.cfg]
[include misc_macro.cfg]
[include fans_leds_therms.cfg]
[include circle.cfg]
[include led_effects.cfg]
[include reshelper.cfg]

[virtual_sdcard]
path: /home/benst/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[exclude_object]

[gcode_arcs] 
resolution: 0.2

[force_move]
enable_force_move:true

[danger_options]
allow_plugin_override: True

[respond]

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_2C0008001751333031373837-if00

[mcu expander]
serial: /dev/serial/by-id/usb-Klipper_stm32f042x6_0F002400115330374E333320-if00
restart_method: command

[input_shaper]
shaper_type_x: smooth_zv
shaper_type_y: smooth_mzv
smoother_freq_x: 149.8
smoother_freq_y: 100.4
#damping_ratio_x: 0.0759
#damping_ratio_y: 0.0288

[resonance_tester]
accel_chip: beacon
probe_points:
	150, 150, 60
max_freq:200
accel_per_hz: 90
hz_per_sec: 1
move_speed: 50
sweeping_accel: 200
sweeping_period: 1.2 #0 for off

[resonance_holder]
accel_per_hz: 180 # Shake intensity

[printer]
kinematics:corexy
max_velocity:1200
max_accel:90000
max_z_velocity:100
max_z_accel:1000
square_corner_velocity:90
minimum_cruise_ratio: 0.5

[constants]

# XY
run_current_ab: 2.5 # ${constants.run_current_ab}
microsteps_ab: 64 # ${constants.microsteps_ab}
homing_speed_x: 100 # ${constants.homing_speed_x}
homing_speed_y:100 # ${constants.homing_speed_y}
full_steps_for_rotation_ab: 200 # ${constants.full_steps_for_rotation_ab}
rotation_distance_ab: 40 # ${constants.rotation_distance_ab}
driver_sgt_x: 1 # ${constants.driver_sgt_x}
homing_current_x_y: 1.2 # ${constants.homing_current_x_y}
homing_current_x1_y1: 0.1 # ${constants.homing_current_x1_y1}

# Z
run_current_z: 1.5 # ${constants.run_current_z}
microsteps_z: 16 # ${constants.microsteps_z}
homing_speed_z: 20 # ${constants.homing_speed_z}
rotation_distance_z: 40 # ${constants.rotation_distance_z}
z_gear_ratio: 80:16 # ${constants.z_gear_ratio}

#E
nozzle_size: 0.4 # ${constants.nozzle_size}
run_current_extruder: 0.8 # ${constants.run_current_extruder}
microsteps_extruder: 16 # ${constants.microsteps_extruder}
full_steps_for_rotation_e: 200 # ${constants.full_steps_for_rotation_e}
rotation_distance_e: 55 # ${constants.rotation_distance_e}
e_gear_ratio: 37:1 # ${constants.e_gear_ratio}

[stepper_x]
step_pin:PE6
dir_pin:PE5
enable_pin:!PC14
endstop_pin: tmc5160_stepper_x:virtual_endstop
position_min:-1.5
position_endstop:301.5
position_max:301.5
homing_retract_dist: 25
homing_positive_dir:true
use_sensorless_homing: true
homing_speed:${constants.homing_speed_x}
microsteps:${constants.microsteps_ab}
rotation_distance:${constants.rotation_distance_ab}
full_steps_per_rotation:${constants.full_steps_for_rotation_ab}

[tmc5160 stepper_x]
cs_pin:PC13
spi_software_sclk_pin:PG8
spi_software_mosi_pin:PG6
spi_software_miso_pin:PG7
interpolate:True
sense_resistor:0.075
current_change_dwell_time: 0.1
diag1_pin: ^!PF4
run_current: ${constants.run_current_ab}
home_current:${constants.homing_current_x_y}
driver_SGT:${constants.driver_sgt_x}
driver_TBL: 2
driver_TOFF: 2
driver_HSTRT: 4
driver_HEND: 6
driver_TPFD: 4

[stepper_x1]
step_pin:PE2
dir_pin:PE1
enable_pin:!PE4
microsteps:${constants.microsteps_ab}
rotation_distance:${constants.rotation_distance_ab}
full_steps_per_rotation:${constants.full_steps_for_rotation_ab}

[tmc5160 stepper_x1]
cs_pin:PE3
spi_software_sclk_pin:PG8
spi_software_mosi_pin:PG6
spi_software_miso_pin:PG7
interpolate:True
sense_resistor:0.075
current_change_dwell_time: 0.1
diag1_pin: ^!PF3
run_current: ${constants.run_current_ab}
home_current:${constants.homing_current_x1_y1}
driver_SGT:${constants.driver_sgt_x}
driver_TBL: 2
driver_TOFF: 2
driver_HSTRT: 4
driver_HEND: 6
driver_TPFD: 4

[stepper_y]
step_pin:PC7
dir_pin:PC8
enable_pin:!PD2
endstop_pin:PF2
position_min:0
position_endstop:311.1
position_max:311.1
homing_retract_dist:0
homing_positive_dir:true
homing_speed:${constants.homing_speed_y}
microsteps:${constants.microsteps_ab}
rotation_distance:${constants.rotation_distance_ab}
full_steps_per_rotation:${constants.full_steps_for_rotation_ab}

[tmc5160 stepper_y]
cs_pin:PC6
spi_software_sclk_pin:PG8
spi_software_mosi_pin:PG6
spi_software_miso_pin:PG7
interpolate:True
sense_resistor:0.075
run_current: ${constants.run_current_ab}
home_current:${constants.homing_current_x_y}
driver_TBL: 2
driver_TOFF: 2
driver_HSTRT: 4
driver_HEND: 6
driver_TPFD: 4

[stepper_y1]
step_pin:PD4
dir_pin:PD3
enable_pin:!PD6
microsteps:${constants.microsteps_ab}
rotation_distance:${constants.rotation_distance_ab}
full_steps_per_rotation:${constants.full_steps_for_rotation_ab}

[tmc5160 stepper_y1]
cs_pin:PD5
spi_software_sclk_pin:PG8
spi_software_mosi_pin:PG6
spi_software_miso_pin:PG7
interpolate:True
sense_resistor:0.075
run_current: ${constants.run_current_ab}
home_current:${constants.homing_current_x1_y1}
driver_TBL: 2
driver_TOFF: 2
driver_HSTRT: 4
driver_HEND: 6
driver_TPFD: 4

[stepper_z]
step_pin:PB8
dir_pin:!PB7
enable_pin:!PE0
position_max:215
position_min:-50.0
homing_retract_dist:0
homing_positive_dir:False
microsteps:${constants.microsteps_z}
rotation_distance:${constants.rotation_distance_z}
gear_ratio:${constants.z_gear_ratio}
endstop_pin: probe:z_virtual_endstop
homing_speed:${constants.homing_speed_z}

[tmc5160 stepper_z]
cs_pin:PB9
spi_software_mosi_pin:PG6
spi_software_miso_pin:PG7
spi_software_sclk_pin:PG8
interpolate:True
sense_resistor:0.075
run_current:${constants.run_current_z}

[stepper_z1]
step_pin:PB4
dir_pin:!PB3
enable_pin:!PB6
microsteps:${constants.microsteps_z}
rotation_distance:${constants.rotation_distance_z}
gear_ratio:${constants.z_gear_ratio}

[tmc5160 stepper_z1]
cs_pin:PB5
spi_software_mosi_pin:PG6
spi_software_miso_pin:PG7
spi_software_sclk_pin:PG8
interpolate:True
sense_resistor:0.075
run_current:${constants.run_current_z}

[stepper_z2]
step_pin:PG13
dir_pin:PG12
enable_pin:!PG15
microsteps:${constants.microsteps_z}
rotation_distance:${constants.rotation_distance_z}
gear_ratio:${constants.z_gear_ratio}

[tmc5160 stepper_z2]
cs_pin:PG14
spi_software_mosi_pin:PG6
spi_software_miso_pin:PG7
spi_software_sclk_pin:PG8
interpolate:True
sense_resistor:0.075
run_current:${constants.run_current_z}

[extruder]
step_pin: PG9
dir_pin: !PD7
enable_pin: !PG11
max_extrude_only_distance:500
max_extrude_cross_section:1000
max_extrude_only_velocity:100 #100
max_extrude_only_accel:1000 #1000
instantaneous_corner_velocity:1
heater_pin:PA3
heater_power:120  
cooling_fan:fan
filament_diameter:1.75
filament_density:1.20
filament_heat_capacity:1.8 
pwm_cycle_time:0.01 #0.01
smooth_time: 2 #2
min_temp:-20
max_temp:400
min_extrude_temp:150
pressure_advance:0.019
pressure_advance_smooth_time:0.03
sensor_type:PT1000
sensor_pin:PB0
rotation_distance: ${constants.rotation_distance_e}
gear_ratio:${constants.e_gear_ratio}
nozzle_diameter:${constants.nozzle_size}
full_steps_per_rotation:${constants.full_steps_for_rotation_e}
microsteps:${constants.microsteps_extruder}

[verify_heater extruder]
max_error:120
check_gain_time:25
hysteresis:20

[tmc5160 extruder]
cs_pin: PG10
spi_software_mosi_pin:PG6
spi_software_miso_pin:PG7
spi_software_sclk_pin:PG8
interpolate:False
sense_resistor:0.075
run_current:${constants.run_current_extruder}

[heater_bed]
heater_pin:PA1
sensor_pin:PB1
sensor_type:ATC Semitec 104GT-2
control:pid
pid_kp:51.430
pid_ki:3.297
pid_kd:200.577
min_temp:-20
max_temp:135
max_power:1.0

[idle_timeout]
timeout:3600
gcode:
	{% if printer.pause_resume.is_paused %}
	M104 S0
	{% else %}
    SET_LED LED=my_neopixel WHITE=0
	M84
	M107
	M106 S0
	SET_FAN_SPEED FAN=fan3 SPEED=0.0
    SET_FAN_SPEED FAN=bed_fans SPEED=0.0
	TURN_OFF_HEATERS
    SET_LED LED=my_neopixel WHITE=0
    idle_off
    FEET_PURPLE
	{% endif %}

[beacon]   
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_5CBB4B585157355957202020FF0E3A13-if00
x_offset: 0 # update with offset from nozzle on your machine
y_offset: 18 # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2
cal_move_speed: 100
backlash_comp: 0.01535
home_gcode_pre_x: _HOME_PRE_AXIS AXIS=X
home_gcode_post_x: _HOME_POST_AXIS AXIS=X
home_gcode_pre_y: _HOME_PRE_AXIS AXIS=Y
home_gcode_post_y: _HOME_POST_AXIS AXIS=Y
home_xy_position: 150, 150 # update for your machine
home_z_hop: 10
home_z_hop_speed: 15
home_xy_move_speed: 500
home_method: proximity # use proximity for induction homing
home_method_when_homed: proximity # after initial calibration use induction
home_autocalibrate: never # contact will calibrate beacon on first home
contact_max_hotend_temperature: 320
contact_sensitivity: 1

[bed_mesh]
zero_reference_position:150, 150
speed:400
horizontal_move_z:5
mesh_min:20,18
mesh_max:280,283
probe_count:20,20
algorithm:bicubic
adaptive_margin: 2

[z_tilt]
z_positions:
	-45, 0
	150, 320
	355, 0
points:
	20, 0
	150, 265
	280, 0
speed:600
horizontal_move_z:5
retries:10
retry_tolerance:0.0125

[motors_sync]
axes: x,y
accel_chip: beacon
chip_filter: median
median_size: 3
microsteps: 16
max_step_size: 3
axes_steps_diff: 4
retries: 0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.4043991713968131,
#*# 	1.726580222984212,
#*# 	0.7658540895225908,
#*# 	0.29379467430970635,
#*# 	0.36892071615363264,
#*# 	0.666570961932094,
#*# 	-0.22970935820695257,
#*# 	-0.7129491838061435,
#*# 	0.2936029604111703,
#*# 	0.432992788835486
#*# model_domain = 1.8378865493372348e-07,1.9006813872176072e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 52.613984
#*# model_offset = 0.00000
#*#
#*# [extruder]
#*# control = mpc
#*# block_heat_capacity = 26.1655
#*# sensor_responsiveness = 0.0668416
#*# ambient_transfer = 0.0855027
#*# fan_ambient_transfer = 0.0855027, 0.129363, 0.142208, 0.152255, 0.153417, 0.159799, 0.165696
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.072044, 0.060855, 0.049042, 0.042303, 0.035315, 0.025947, 0.024197, 0.024859, 0.020880, 0.020494, 0.019840, 0.023951, 0.026390, 0.029835, 0.034514, 0.041287, 0.046099, 0.051611, 0.057413, 0.050871
#*# 	0.073014, 0.063236, 0.050918, 0.041727, 0.035987, 0.026907, 0.025966, 0.026254, 0.024811, 0.022535, 0.022075, 0.020144, 0.025853, 0.029651, 0.034601, 0.043072, 0.046890, 0.050024, 0.057037, 0.047784
#*# 	0.070172, 0.063307, 0.051733, 0.040115, 0.033495, 0.026202, 0.022828, 0.021270, 0.021406, 0.018975, 0.018959, 0.016895, 0.021801, 0.024719, 0.029999, 0.036698, 0.041082, 0.046755, 0.052243, 0.045714
#*# 	0.066512, 0.058853, 0.048270, 0.038475, 0.031032, 0.023378, 0.017549, 0.014736, 0.014723, 0.013003, 0.013183, 0.012351, 0.016499, 0.019900, 0.025265, 0.030392, 0.035025, 0.043051, 0.049728, 0.040951
#*# 	0.064156, 0.057000, 0.045356, 0.039133, 0.029971, 0.022578, 0.014820, 0.010435, 0.011338, 0.010443, 0.008518, 0.007436, 0.011973, 0.016347, 0.018932, 0.025272, 0.028706, 0.039174, 0.045928, 0.038519
#*# 	0.063534, 0.054627, 0.044566, 0.036310, 0.029850, 0.019051, 0.013328, 0.010130, 0.009432, 0.005447, 0.002647, 0.002328, 0.007649, 0.011586, 0.017956, 0.021015, 0.026090, 0.033803, 0.040909, 0.031922
#*# 	0.060205, 0.054207, 0.038756, 0.027488, 0.022027, 0.011071, 0.005840, 0.001914, 0.000791, -0.003052, -0.003292, -0.001767, 0.000557, 0.006209, 0.008698, 0.013083, 0.016188, 0.024251, 0.034547, 0.026448
#*# 	0.054658, 0.045957, 0.036096, 0.023496, 0.013363, 0.006078, -0.000796, -0.007265, -0.009509, -0.008042, -0.005693, -0.006076, -0.003467, 0.001073, 0.004402, 0.006299, 0.009906, 0.017603, 0.024002, 0.017748
#*# 	0.047651, 0.042583, 0.032160, 0.018266, 0.011048, 0.000819, -0.007037, -0.010589, -0.012781, -0.008593, -0.002207, -0.005858, -0.008567, -0.005093, -0.004727, -0.000635, 0.002103, 0.013119, 0.018394, 0.012529
#*# 	0.043784, 0.035626, 0.027409, 0.016478, 0.010090, -0.000500, -0.006158, -0.009710, -0.007957, -0.002509, -0.001275, -0.007612, -0.009269, -0.008693, -0.005960, -0.000277, 0.003725, 0.011641, 0.017148, 0.008450
#*# 	0.041617, 0.036279, 0.025027, 0.014589, 0.008537, 0.001696, -0.006548, -0.010461, -0.004890, 0.003258, -0.000195, -0.010850, -0.013098, -0.008641, -0.007289, -0.002422, 0.002476, 0.011096, 0.018137, 0.013391
#*# 	0.036909, 0.029427, 0.018119, 0.011300, 0.007873, -0.000272, -0.007492, -0.011918, -0.010638, -0.006543, -0.011232, -0.016631, -0.015120, -0.011790, -0.007265, -0.002229, 0.005456, 0.011122, 0.017116, 0.014330
#*# 	0.033232, 0.026654, 0.015387, 0.008588, 0.004526, -0.003891, -0.009764, -0.013929, -0.016214, -0.016666, -0.017374, -0.018339, -0.016026, -0.011757, -0.007465, 0.000561, 0.004086, 0.009313, 0.017104, 0.014006
#*# 	0.032466, 0.028188, 0.018343, 0.012675, 0.009407, 0.001735, -0.006305, -0.011843, -0.013200, -0.013975, -0.015406, -0.017694, -0.012504, -0.007314, -0.002324, 0.005030, 0.009061, 0.014391, 0.019787, 0.016204
#*# 	0.031285, 0.026984, 0.016901, 0.010822, 0.008854, 0.003299, 0.000205, -0.002285, -0.002168, -0.007236, -0.007057, -0.007351, -0.007559, -0.003050, 0.001452, 0.008126, 0.012737, 0.019139, 0.026308, 0.022887
#*# 	0.026727, 0.022625, 0.015857, 0.014235, 0.009726, 0.004858, 0.005271, 0.003749, 0.005788, 0.004840, 0.001401, -0.000860, 0.001654, 0.004676, 0.011207, 0.016177, 0.020438, 0.026867, 0.030482, 0.026706
#*# 	0.021657, 0.021337, 0.016178, 0.014652, 0.013310, 0.010781, 0.009904, 0.011882, 0.016551, 0.016458, 0.012876, 0.011662, 0.011777, 0.017472, 0.021683, 0.029461, 0.033046, 0.037893, 0.045598, 0.040439
#*# 	0.017883, 0.021601, 0.016962, 0.018963, 0.018721, 0.019136, 0.017439, 0.020421, 0.026371, 0.028022, 0.025874, 0.023643, 0.027869, 0.032107, 0.037827, 0.043639, 0.048108, 0.050549, 0.056680, 0.054625
#*# 	0.016807, 0.019664, 0.019934, 0.022072, 0.027328, 0.028074, 0.030219, 0.034612, 0.041403, 0.043251, 0.041539, 0.039610, 0.043548, 0.052174, 0.056162, 0.063819, 0.069423, 0.070457, 0.079528, 0.074948
#*# 	0.018261, 0.022195, 0.026101, 0.029783, 0.037452, 0.043573, 0.049471, 0.050625, 0.057318, 0.058102, 0.056564, 0.058409, 0.065170, 0.070293, 0.076352, 0.085941, 0.092332, 0.094647, 0.100522, 0.097081
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 282.0
#*# min_y = 18.0
#*# max_y = 253.0
#*#
#*# [motors_sync]
#*# steps_model_x = power,
#*# 	  1373.8456071410885,
#*# 	  1.4978595623522843
#*# steps_model_y = power,
#*# 	  1373.8456071410885,
#*# 	  1.4978595623522843
